<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brawlchara</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="icon" href="/public/32×32.png" type="image/png" sizes="32×32" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    #tokenList code {
      display: inline-block;
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: middle;
    }
    #disclaimer {
      color: #6b0000;
      font-weight: 600;
      font-size: 0.8rem;
      background: #fff5f5;
      padding: 5px 10px;
      border: 1px solid #d48b8b;
      border-radius: 4px;
      margin-bottom: 8px;
      max-width: 320px;
      line-height: 1.2;
      user-select: none;
    }
    button.loading {
      opacity: 0.6;
      cursor: not-allowed;
    }
    /* iframeのスタイルは不要になるため削除 */
    /* iframe#docFrame {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      margin-top: 1rem;
    } */
  </style>
</head>
<body>
  <p id="disclaimer">
    ※このアプリは公式ではありません。非公式のファンメイドツールです。ご利用は自己責任でお願いします。
  </p>

  <h1><i class="fa-solid fa-user-ghost"></i> Brawlchara</h1>

  <label for="expires">トークン有効期限を選択:</label>
  <select id="expires">
    <option value="3600">1時間</option>
    <option value="86400">24時間</option>
    <option value="604800">7日間</option>
    <option value="0">無制限</option>
  </select>
  <button id="generateToken"><i class="fa-solid fa-key"></i> トークン生成</button>
  <button id="copyToken" disabled><i class="fa-regular fa-copy"></i> トークンをコピー</button>

  <p>生成されたトークン:</p>
  <textarea id="tokenOutput" rows="4" cols="60" readonly></textarea>

  <h2>生成済みトークン一覧</h2>
  <ul id="tokenList">
    <li>トークンがありません</li>
  </ul>

  <h2>キャラを取得</h2>
  <button id="getCharacter"><i class="fa-solid fa-dice-d20"></i> 試す</button>
  <pre id="characterResult"></pre>

  ---

  <h2><i class="fa-solid fa-book"></i> ドキュメントはこちらから</h2>
  <p>
    <a href="https://document-api-brawl-chara.vercel.app/" target="_blank" rel="noopener noreferrer">BrawlStars Character API ドキュメントを見る</a>
  </p>

  <script>
    const generateBtn = document.getElementById('generateToken');
    const getCharBtn = document.getElementById('getCharacter');
    const copyBtn = document.getElementById('copyToken');
    const tokenOutput = document.getElementById('tokenOutput');
    const characterResult = document.getElementById('characterResult');
    const tokenList = document.getElementById('tokenList');
    const STORAGE_KEY = 'brawlstar_tokens';

    function setLoading(button, isLoading) {
      if (isLoading) {
        button.textContent = '処理中...';
        button.classList.add('loading');
        button.disabled = true;
      } else {
        if (button.id === 'generateToken') button.innerHTML = '<i class="fa-solid fa-key"></i> トークン生成';
        else if (button.id === 'getCharacter') button.innerHTML = '<i class="fa-solid fa-dice-d20"></i> 試す';
        button.classList.remove('loading');
        button.disabled = false;
      }
    }

    function loadTokens() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveTokens(tokens) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tokens));
    }

    function shortenToken(token) {
      if (token.length <= 20) return token;
      return token.slice(0, 10) + '...' + token.slice(-6);
    }

    function renderTokenList() {
      const tokens = loadTokens();
      if (tokens.length === 0) {
        tokenList.innerHTML = '<li>トークンがありません</li>';
        return;
      }
      tokenList.innerHTML = '';
      tokens.forEach(({ token, expiresAt }, index) => {
        const expText = expiresAt === 0 ? '無制限' : new Date(expiresAt).toLocaleString();
        const li = document.createElement('li');
        li.innerHTML = `
          <button data-index="${index}" class="useTokenBtn" title="このトークンを使う">▶</button>
          <code>${shortenToken(token)}</code>
          <small>有効期限: ${expText}</small>
          <button data-index="${index}" class="delTokenBtn" title="削除" style="color:red;">✕</button>
        `;
        tokenList.appendChild(li);
      });

      document.querySelectorAll('.useTokenBtn').forEach(btn => {
        btn.onclick = () => {
          const idx = btn.getAttribute('data-index');
          const tokens = loadTokens();
          tokenOutput.value = tokens[idx].token;
          copyBtn.disabled = false;
          characterResult.textContent = '';
        };
      });

      document.querySelectorAll('.delTokenBtn').forEach(btn => {
        btn.onclick = () => {
          const idx = btn.getAttribute('data-index');
          let tokens = loadTokens();
          tokens.splice(idx, 1);
          saveTokens(tokens);
          renderTokenList();
          if (tokenOutput.value && !tokens.some(t => t.token === tokenOutput.value)) {
            tokenOutput.value = '';
            copyBtn.disabled = true;
            characterResult.textContent = '';
          }
        };
      });
    }

    async function generateToken() {
      setLoading(generateBtn, true);
      characterResult.textContent = '';
      copyBtn.disabled = true;
      try {
        const expiresInSec = parseInt(document.getElementById('expires').value, 10);
        const res = await fetch('/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ expiresIn: expiresInSec === 0 ? 'never' : expiresInSec })
        });
        if (!res.ok) throw new Error(`HTTPエラー: ${res.status}`);
        const data = await res.json();
        if (data.token) {
          tokenOutput.value = data.token;
          copyBtn.disabled = false;
          const expiresAt = data.expiresIn === 'never' ? 0 : Date.now() + parseInt(data.expiresIn) * 1000;
          let tokens = loadTokens();
          if (!tokens.some(t => t.token === data.token)) {
            tokens.push({ token: data.token, expiresAt });
            saveTokens(tokens);
            renderTokenList();
          }
        } else {
          tokenOutput.value = 'トークン生成に失敗しました';
        }
      } catch (e) {
        tokenOutput.value = `エラーが発生しました: ${e.message}`;
      } finally {
        setLoading(generateBtn, false);
      }
    }

    async function getCharacter() {
      const token = tokenOutput.value.trim();
      if (!token) {
        alert('まずトークンを生成または選択してください');
        return;
      }
      setLoading(getCharBtn, true);
      characterResult.textContent = '';
      try {
        const res = await fetch(`/api/character?token=${encodeURIComponent(token)}`);
        if (!res.ok) throw new Error(`HTTPエラー: ${res.status}`);
        const data = await res.json();
        if (data.error) {
          characterResult.textContent = 'エラー: ' + data.error;
        } else {
          characterResult.textContent = `名前: ${data.name}\nレア度: ${data.rarity}\nタイプ: ${data.role}`;
        }
      } catch (e) {
        characterResult.textContent = `通信エラーが発生しました: ${e.message}`;
      } finally {
        setLoading(getCharBtn, false);
      }
    }

    function copyTokenToClipboard() {
      if (!tokenOutput.value) {
        alert('コピーするトークンがありません');
        return;
      }
      tokenOutput.select();
      document.execCommand('copy');
      alert('トークンをコピーしました！');
    }

    renderTokenList();
    generateBtn.addEventListener('click', generateToken);
    getCharBtn.addEventListener('click', getCharacter);
    copyBtn.addEventListener('click', copyTokenToClipboard);
  </script>
</body>
</html>
