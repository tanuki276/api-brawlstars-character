<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ブロスタキャラAPI トークン生成・管理</title>
  <style>
  body { font-family: sans-serif; max-width: 600px; margin: 2em auto; padding: 0 1em; }
    label, select, button, textarea, pre, ul { display: block; margin-top: 1em; }
    textarea { width: 100%; font-family: monospace; }
    pre { white-space: pre-wrap; background: #eee; padding: 1em; border-radius: 4px; }
    button { padding: 0.4em 1em; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: default; }
    #tokenOutput { font-family: monospace; }
    .loading { opacity: 0.6; pointer-events: none; }
    ul { padding-left: 1em; }
    li { margin-bottom: 0.5em; }
    li button { margin-left: 0.5em; }
    code { background: #f0f0f0; padding: 2px 4px; border-radius: 3px; }
  </style>
</head>

<body>
  <h1>ブロスタキャラクターAPI</h1>
  <label for="expires">トークン有効期限を選択:</label>
  <select id="expires">
    <option value="3600">1時間</option>
    <option value="86400">24時間</option>
    <option value="604800">7日間</option>
    <option value="0">無制限</option>
  </select>
  <button id="generateToken">トークン生成</button>
  <button id="copyToken" disabled>トークンをコピー</button>
  <p>生成されたトークン:</p>
  <textarea id="tokenOutput" rows="4" cols="60" readonly>
  </textarea>
  <h2>生成済みトークン一覧</h2>
  <ul id="tokenList">
    <li>トークンがありません</li>
  </ul>
  <h2>キャラを取得</h2>
  <label for="lang">言語:</label>
  <select id="lang">
    <option value="ja">日本語</option>
    <option value="en">英語</option>
    <option value="zh">中国語</option>
    <option value="ko">韓国語</option>
  </select>
  <button id="getCharacter">取得</button> <pre id="characterResult"></pre>
  <script>
  const generateBtn = document.getElementById('generateToken');
    const getCharBtn = document.getElementById('getCharacter');
    const copyBtn = document.getElementById('copyToken');
    const tokenOutput = document.getElementById('tokenOutput');
    const characterResult = document.getElementById('characterResult');
    const tokenList = document.getElementById('tokenList');
  
    const STORAGE_KEY = 'brawlstar_tokens';
  
    function setLoading(button, isLoading) {
      if (isLoading) {
        button.textContent = '処理中...';
        button.classList.add('loading');
        button.disabled = true;
      } else {
        if (button.id === 'generateToken') button.textContent = 'トークン生成';
        else if (button.id === 'getCharacter') button.textContent = '取得';
        button.classList.remove('loading');
        button.disabled = false;
      }
    }
  
    // ローカルストレージからトークン一覧を取得
    function loadTokens() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }
  
    // ローカルストレージに保存
    function saveTokens(tokens) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tokens));
    }
  
    // トークン一覧画面表示
    function renderTokenList() {
      const tokens = loadTokens();
      if (tokens.length === 0) {
        tokenList.innerHTML = '<li>トークンがありません';
        return;
      }
      tokenList.innerHTML = '';
      tokens.forEach(({ token, expiresAt }, index) => {
        const expText = expiresAt === 0 ? '無制限' : new Date(expiresAt).toLocaleString();
        const li = document.createElement('li');
        li.innerHTML = `
          <button data-index="${index}" class="useTokenBtn" title="このトークンを使う">▶
          <code>${token} 
          <small>有効期限: ${expText}
          <button data-index="${index}" class="delTokenBtn" title="削除" style="color:red;">✕
        `;
        tokenList.appendChild(li);
      });
  
      // 利用ボタン
      document.querySelectorAll('.useTokenBtn').forEach(btn => {
        btn.onclick = () => {
          const idx = btn.getAttribute('data-index');
          const tokens = loadTokens();
          tokenOutput.value = tokens[idx].token;
          copyBtn.disabled = false;
          characterResult.textContent = '';
        };
      });
  
      // 削除ボタン
      document.querySelectorAll('.delTokenBtn').forEach(btn => {
        btn.onclick = () => {
          const idx = btn.getAttribute('data-index');
          let tokens = loadTokens();
          tokens.splice(idx, 1);
          saveTokens(tokens);
          renderTokenList();
          // もし今のテキストエリアにあるトークンを削除したら消す
          if (tokenOutput.value && !tokens.some(t => t.token === tokenOutput.value)) {
            tokenOutput.value = '';
            copyBtn.disabled = true;
            characterResult.textContent = '';
          }
        };
      });
    }
  
    async function generateToken() {
      setLoading(generateBtn, true);
      characterResult.textContent = '';
      copyBtn.disabled = true;
      try {
        const expiresInSec = parseInt(document.getElementById('expires').value, 10);
        const res = await fetch('/api/token', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ expiresIn: expiresInSec })
        });
        if (!res.ok) throw new Error(`HTTPエラー: ${res.status}`);
        const data = await res.json();
        if (data.token) {
          tokenOutput.value = data.token;
          copyBtn.disabled = false;
  
          // 期限の計算（0は無制限）
          const expiresAt = expiresInSec === 0 ? 0 : Date.now() + expiresInSec * 1000;
  
          // 既存トークンと重複排除（同じトークンがなければ追加）
          let tokens = loadTokens();
          if (!tokens.some(t => t.token === data.token)) {
            tokens.push({ token: data.token, expiresAt });
            saveTokens(tokens);
            renderTokenList();
          }
        } else {
          tokenOutput.value = 'トークン生成に失敗しました';
        }
      } catch (e) {
        tokenOutput.value = `エラーが発生しました: ${e.message}`;
      } finally {
        setLoading(generateBtn, false);
      }
    }
  
    async function getCharacter() {
      const token = tokenOutput.value.trim();
      if (!token) {
        alert('まずトークンを生成または選択してください');
        return;
      }
      setLoading(getCharBtn, true);
      characterResult.textContent = '';
      try {
        const lang = document.getElementById('lang').value;
        const res = await fetch(`/api/character?token=${encodeURIComponent(token)}&lang=${lang}`);
        if (!res.ok) throw new Error(`HTTPエラー: ${res.status}`);
        const data = await res.json();
        if (data.error) {
          characterResult.textContent = 'エラー: ' + data.error;
        } else {
          characterResult.textContent =
            `名前: ${data.name}\nレア度: ${data.rarity}\nタイプ: ${data.type}`;
        }
      } catch (e) {
        characterResult.textContent = `通信エラーが発生しました: ${e.message}`;
      } finally {
        setLoading(getCharBtn, false);
      }
    }
  
    function copyTokenToClipboard() {
      if (!tokenOutput.value) {
        alert('コピーするトークンがありません');
        return;
      }
      tokenOutput.select();
      tokenOutput.setSelectionRange(0, 99999); // モバイル対応
      document.execCommand('copy');
      alert('トークンをコピーしました！');
    }
  
    // 初期表示
    renderTokenList();
  
    generateBtn.addEventListener('click', generateToken);
    getCharBtn.addEventListener('click', getCharacter);
    copyBtn.addEventListener('click', copyTokenToClipboard);
  </script>
</body>

  </html>
